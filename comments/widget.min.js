"use strict";const console=(e=>{var t=!1;return window.console.groupCollapsed("AllBooms comments widget"),new Proxy(window.console,{get:(e,n)=>t&&"function"==typeof e[n]?(...t)=>{e.groupCollapsed("AllBooms comments widget"),e[n](...t),e.groupEnd()}:(t||"groupEnd"!=n||(t=!0),e[n])})})();document.head.appendChild((()=>{var e=["https://fonts.googleapis.com/css?family=Roboto","https://cdn.jsdelivr.net/gh/FavoriStyle/AllBooms-brand-icons@3.0.0/dist/allbooms-brand-icons.css"];e.forEach((t,n)=>{e[n]=`@import url("${t.replace('"',"%22").replace("\\","%5C")}");\n`});var t=document.createElement("style");return t.innerHTML=e.join(""),console.log("Added global style to use fonts in widget:\n",t.firstChild),t})());const getDefinitions=(()=>{const e=(async()=>{const{APIref:e,API:t,defaultStyles:n,currentUser:s,normalizeDate:a,http:i,wait:r,ExtString:o,Link:l,Cookies:d}=await(async()=>{const[{_system:{normalizeDate:e,wait:t,http:n,ExtString:s,Link:a,Cookies:i},defaultStyles:r},{APIref:o,API:l,currentUser:d}]=await(async()=>{const e=require(__dirname+"/../_system.min.js");return await Promise.all([(async()=>{const t=await e;return{_system:t,defaultStyles:await t.http.get(__dirname+"/style.css")}})(),(async()=>{const t=await require(__dirname+"/../APIref.min.js"),n=new t,s=(await e).Cookies.get("allbooms_token");var a={APIref:t,API:n,currentUser:s?await n.user.getInfo({token:s,list:["id","fullName","avatar"]}):{}};return a.currentUser.id?a.currentUser._token=s:a.currentUser=null,a})()])})();return{APIref:o,API:l,defaultStyles:r,currentUser:d,normalizeDate:e,wait:t,http:n,ExtString:s,Link:a,Cookies:i}})();return{APIref:e,API:t,defaultStyles:n,dictionary:{ru:{placeholder:"Ваш комментарий",submitText:"Отправить",submittingText:"Отправка...",userNotLogged:"Для добавления комментария",login:"Войдите"}},http:i,wait:r,currentUser:s,normalizeDate:a,String:o,Link:l,Cookies:d}})();return()=>e})(),res=(async()=>{const{APIref:e,API:t,dictionary:n,wait:s,normalizeDate:a,Link:i,Cookies:r,defaultStyles:o}=await getDefinitions();var{currentUser:l}=await getDefinitions();await(async()=>{var e=new i(location.href);void 0!==e.params.save_allbooms_token&&e.params.token&&((l=await t.user.getInfo({token:e.params.token,list:["id","fullName","avatar"]}))&&r.set("allbooms_token",e.params.token),delete e.params.save_allbooms_token,delete e.params.token,window.history.pushState(null,null,e.href))})();class d{constructor({id:t,text:n,user:{id:s,fullName:i,avatar:r},timestamp:o}){const l=document.createElement("table"),d=document.createElement("tbody"),c=document.createElement("tr"),m=document.createElement("tr"),u=document.createElement("td"),p=document.createElement("td"),h=document.createElement("td"),g=document.createElement("td"),f=document.createElement("a"),b=document.createElement("a"),w=document.createElement("img");return u.setAttribute("rowspan","2"),g.setAttribute("colspan","2"),l.appendChild(d),d.appendChild(c),d.appendChild(m),c.appendChild(u),c.appendChild(p),c.appendChild(h),m.appendChild(g),u.appendChild(f),f.appendChild(w),p.appendChild(b),w.setAttribute("src",r),f.setAttribute("href",`https://${e.baseHost}/${s}`),b.setAttribute("href",`https://${e.baseHost}/${s}`),b.innerText=i,h.innerText=a(new Date(1e3*o)),g.innerText=n,l.setAttribute("class","single-comment"),l}}const c=(()=>{return class extends Array{constructor(){super(),this.ids=[]}prependNew(e={comments:[]},t){e.comments.reverse().forEach(n=>{n.user=e.users[n.userid],(n=function(e){if(-1==this.ids.indexOf(e.id))return this.push(e),this.ids.push(e.id),e}.call(this,n))&&function(e,t){e=new d(e),t.firstElementChild?t.insertBefore(e,t.firstElementChild):t.appendChild(e)}(n,t)})}add(e,t){this.prependNew({comments:[{id:e.id,timestamp:e.timestamp,userid:e.user.id,text:e.text}],users:{[e.user.id]:e.user}},t)}}})();class m{constructor(e,a,r){if(!/^[a-zA-Z0-9_\-]+$/.test(a))throw new SyntaxError("widgetID must contain only latin symbols, digits, - or _");for(var d in r)null===r[d]&&delete r[d];r=Object.assign({lang:"ru"},r),console.log("Widget params before assign:",{appID:e,widgetID:a,options:r});const m=Object.assign(n[r.lang],r.strings||{}),u=new c;this.conainer=document.createElement("div"),this.conainer.id=`comments-widget-${a}`,this.conainer.setAttribute("class","allbooms-comments-widget"),this.conainer.setAttribute("style","width: 280px; --theme-color: #00b1b3; --highlighted-text-color: #ffffff");var p=document.createElement("input"),h=document.createElement("button"),g=document.createElement("div"),f=document.createElement("style");return this.conainer.appendChild(p),this.conainer.appendChild(h),this.conainer.appendChild(g),document.head.appendChild(f),p.placeholder=m.placeholder,p.setAttribute("class","comment-input"),h.type="submit",h.setAttribute("class","comment-input-submit"),h.innerText=m.submitText,g.setAttribute("class","comments-container"),f.innerHTML=o+(r.style||""),(()=>{var e,t="";for(e=0;e<f.sheet.cssRules.length;e++)t+=`#${this.conainer.id} ${f.sheet.cssRules[e].cssText}`;f.innerHTML=t,console.log([f.sheet])})(),l||(p.placeholder=m.userNotLogged,p.setAttribute("disabled",""),h.innerText=m.login,h.innerHTML=h.innerHTML+' <i class="allbooms-brand-icons-allbooms"></i>',h.classList.add("login-highlight")),h.addEventListener("click",async n=>{if(n.preventDefault(),l){if(p.value){h.setAttribute("disabled",""),h.value=m.submittingText;let{id:e,timestamp:n}=await t.comments.external.add({token:l._token,widget_id:a,text:p.value});u.add({id:e,timestamp:n,user:l,text:p.value},g),h.value=m.submitText,h.removeAttribute("disabled")}}else{var s=new i(location.href);s.params.save_allbooms_token="",window.location.href=`https://allbooms.com/getToken?callback=${encodeURIComponent(s.href)}&appid=${encodeURIComponent(e)}`}}),async function e(n,a,i,r,o=2e3){n.prependNew(await t.comments.external.list({app_id:i,widget_id:r}),a),await s(o),e(n,a,i,r,o)}(u,g,e,a),this.conainer}}return customElements.define("allbooms-comments",class extends HTMLElement{constructor(){super();var e=this.attachShadow({mode:"closed"});const t=this.getAttribute("data-appid"),n=this.getAttribute("data-widgetid"),s={lang:this.getAttribute("data-lang"),strings:this.getAttribute("data-strings"),style:this.getAttribute("data-style")};s.strings&&(s.strings=JSON.parse(s.strings)),e.appendChild(new m(t,n,s))}}),class{constructor(e,t,n){const s=document.createElement("div");var a=`<allbooms-comments data-appid="${e}" data-widgetid="${t}"`;return n&&(n.lang&&(a+=` data-lang="${n.lang}"`),n.strings&&(a+=` data-strings="${JSON.stringify(n.strings)}"`),n.style&&(a+=` data-style="${n.style}"`)),s.innerHTML=a+"></allbooms-comments>",s.children[0]}}})();exports.__esModule=!0,exports.default=res;;try{let b=await exports.default;module.exports=b}catch(b){console.warn('Looks like "await" cannot be used at the top level of the module. Defaulted export to ES module')}console.log('Exported',module.exports);console.groupEnd();