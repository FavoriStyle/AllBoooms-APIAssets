import"../internal/roboto.js";import"../internal/allbooms-brand-icons.js";import APIReference from"../internal/APIref.js";import{createElement,htmlSafeText,normalizeDate,currentUser,Link,currentToken,argsEncode,argsDecode,Awaiter,wait}from"../internal/_system.js";import*as Dictionary from"./dictionary.js";import WidgetStyle from"./widget.style.js";import PerfectScrollbar from"../3rd-party/PerfectScrollbar/index.js";const requestTimeout=2e3,API=new APIReference,locationProcess=(async()=>{const e=new Link(location.href);if(void 0!==e.params.save_allbooms_token&&e.params.token){await API.user.getMe({token:e.params.token})&&currentToken.save(e.params.token),delete e.params.save_allbooms_token,delete e.params.token,window.history.pushState(null,null,e.href)}})();class CommentsTable{constructor(e){this.root=e}static _dateUpdate(e,t){const n=normalizeDate(t);e.innerText!==n&&(e.innerText=n)}static _generateElement({id:e,uid:t,avatar:n,name:a,text:s,time:r}){const i=createElement({name:"div",attrs:{commentid:e},childs:[{name:"div",childs:[{name:"img",attrs:{src:n}}]},{name:"div",attrs:{class:"name"},childs:[{name:"a",attrs:{href:APIReference.host+"/"+t,target:"_blank"},html:htmlSafeText(a)}]},{name:"div",attrs:{class:"time"},html:normalizeDate(r)},{name:"div",attrs:{class:"comment"},html:htmlSafeText(s)}]});return setInterval(this._dateUpdate.bind(null,i.children[2],r),1e4),i}_commentAlreadyThere(e){return!!this.root.querySelector(`div[commentid="${e}"]`)}prepend({id:e,uid:t,avatar:n,name:a,text:s,time:r}){if(this._commentAlreadyThere(e))return;this._lastId=e;const i=CommentsTable._generateElement({id:e,uid:t,avatar:n,name:a,text:s,time:r}),o=this.root.querySelector("div[commentid]");o?this.root.insertBefore(i,o):this.root.appendChild(i)}append({id:e,uid:t,avatar:n,name:a,text:s,time:r}){if(this._commentAlreadyThere(e))return;this._lastId=e;const i=CommentsTable._generateElement({id:e,uid:t,avatar:n,name:a,text:s,time:r});this.root.appendChild(i)}}const userStorage=Symbol();function setIntervalForAsync(e,t){function n(){e().then(a)}var a=setTimeout.bind(null,n,t);n()}function _getCommentId(e){if(e)return e.getAttribute("commentid")}class AllBoomsCommentsWidget extends HTMLElement{constructor(){super(),this.appID=decodeURIComponent(this.getAttribute("data-appid")),this.widgetID=decodeURIComponent(this.getAttribute("data-widgetid"));const e=function(){this[userStorage]=Object.assign([],{awaiters:this[userStorage]?this[userStorage].awaiters:{},clear:e})}.bind(this);e();const t=decodeURIComponent(this.getAttribute("data-lang")||"ru"),n=(argsDecode(this.getAttribute("data-strings")),Dictionary[t]),a=this.attachShadow({mode:"closed"});this.styles=new WidgetStyle(a);const s=createElement({name:"div",attrs:{class:"input-and-button-wrapper"},childs:[{name:"div",attrs:{contentEditable:""}},{name:"div"},{name:"a",attrs:{href:"#",draggable:"false"},childs:[{name:"span"}]}]}),r=createElement({name:"div",attrs:{class:"comments-wrapper"}}),i=s.children[0],o=s.children[1],l=s.children[2],d=l.children[0];function m(){return i.innerText.replace(/^\s+/g,"").replace(/\s+$/g,"")}this.table=new CommentsTable(r),setInterval(()=>m()?o.style.display?null:o.style.display="none":o.style.display?o.style.display="":null),new PerfectScrollbar(r,{root:a});let c=!0;r.addEventListener("ps-scroll-y",async()=>{c&&r.getBoundingClientRect().bottom-r.children[r.children.length-11].getBoundingClientRect().y>=0&&!this._requestBusy&&(this._requestBusy=!0,await this.requestComments()||(c=!1),this._requestBusy=!1)});const h=(()=>{let e=!1;return{up:t=>13===(t.preventDefault(),t.which)&&e?(e=!1,l.classList.remove("active"),void l.click()):null,down:t=>13===t.which?t.shiftKey?e?t.preventDefault():null:(t.preventDefault(),e?null:(e=!0,void l.classList.add("active"))):null}})();var u;(async()=>{await locationProcess,await currentUser()?(o.innerText=n.placeholder,i.addEventListener("keydown",h.down),i.addEventListener("keyup",h.up),d.innerText=n.submitText,l.addEventListener("click",()=>{const e=m();e?(i.disabled=!0,l.classList.add("disabled"),API.comments.external.add({token:currentToken(),widget_id:this.widgetID,text:e}).then(({id:e,timestamp:t})=>{u="",i.innerText=u,i.disabled=!1,l.classList.remove("disabled")})):alert(n.noCommentText)})):(o.innerText=n.userNotLogged,i.disabled=!0,l.classList.add("login-highlight"),d.innerText=n.login,l.addEventListener("click",e=>{const t=new Link(location.href);t.params.save_allbooms_token="",e.preventDefault(),location.href=`${APIReference.host}/getToken?callback=${encodeURIComponent(t.href)}&appid=${encodeURIComponent(this.appID)}`}));const e=createElement({name:"div",attrs:{class:"box"}});e.append(s,r),a.append(e)})(),(async()=>{this._requestBusy=!0,await this.requestComments(),this._requestBusy=!1,setTimeout(this.listenForComments.bind(this),requestTimeout)})()}getFirstCommentId(){return _getCommentId(this.table.root.querySelector("div[commentid]"))}getLastCommentId(){const e=this.table.root.querySelectorAll("div[commentid]");return _getCommentId(e[e.length-1])}async requestComments(e=!1){const t=this.onNewComment.bind(this,e?"prepend":"append"),n={app_id:this.appID,widget_id:this.widgetID,after:e?this.getFirstCommentId():this.getLastCommentId(),reversed:e},a=await API.comments.external.list(n);return a.forEach(t),a.length}async userInfo(e){const t=this[userStorage];return t.latest=e,t.awaiters[e]||(t.awaiters[e]=new Awaiter,t.push(e),wait(20).then(()=>{t.latest===e&&(t.clear(),API.user.getInfo({list:t}).then(e=>{t.forEach(n=>{t.awaiters[n].resolve(e[n])})}).catch(e=>{t.forEach(n=>{t.awaiters[n].reject(e)})}))})),await t.awaiters[e]}async onNewComment(e,{id:t,userid:n,text:a,timestamp:s}){const{fullName:r,avatar:i}=await this.userInfo(n);this.table[e]({id:t,text:a,time:s,uid:n,name:r,avatar:i})}listenForComments(){setIntervalForAsync(this.requestComments.bind(this,!0),requestTimeout)}}const cssVars=(()=>{const e={"border-radius":2,width:280,height:400,"theme-color":"#00b1b3","highlighted-text-color":"#fff"};var t="";for(var n in e)t+=`--${n}:${"number"==typeof e[n]?e[n]+"px":e[n]};`;return t})();customElements.define("allbooms-comments",AllBoomsCommentsWidget);export default class{constructor(e,t,n){return n=n||{},createElement({name:"allbooms-comments",attrs:{"data-appid":encodeURIComponent(e),"data-widgetid":encodeURIComponent(t),"data-strings":argsEncode(n.strings),"data-lang":encodeURIComponent(n.lang||""),style:cssVars}})}};