import APIReference from"../internal/APIref.js";import{createElement,htmlSafeText,normalizeDate,currentUser,Link,currentToken,argsEncode,argsDecode,Awaiter,wait}from"../internal/_system.js";import*as Dictionary from"./dictionary.js";import WidgetStyle from"./widget.style.js";import PerfectScrollbar from"./PerfectScrollbar.js";import"../internal/roboto.js";import"../internal/allbooms-brand-icons.js";const requestTimeout=2e3,API=new APIReference,locationProcess=(async()=>{const e=new Link(location.href);if(void 0!==e.params.save_allbooms_token&&e.params.token){await API.user.getMe({token:e.params.token})&&currentToken.save(e.params.token),delete e.params.save_allbooms_token,delete e.params.token,window.history.pushState(null,null,e.href)}})();class CommentsTable{constructor(e){this.root=e}static _dateUpdate(e,t){const a=normalizeDate(t);e.innerText!==a&&(e.innerText=a)}static _generateElement({id:e,uid:t,avatar:a,name:n,text:s,time:r}){const i=createElement({name:"div",attrs:{commentid:e},childs:[{name:"div",childs:[{name:"img",attrs:{src:a}}]},{name:"div",attrs:{class:"name"},childs:[{name:"a",attrs:{href:APIReference.baseHost+"/"+t},html:htmlSafeText(n)}]},{name:"div",attrs:{class:"time"},html:normalizeDate(r)},{name:"div",attrs:{class:"comment"},html:htmlSafeText(s)}]});return setInterval(this._dateUpdate.bind(null,i.children[2],r),1e3),i}_commentAlreadyThere(e){return!!this.root.querySelector(`div[commentid="${e}"]`)}prepend({id:e,uid:t,avatar:a,name:n,text:s,time:r}){if(this._commentAlreadyThere(e))return;this._lastId=e;const i=CommentsTable._generateElement({id:e,uid:t,avatar:a,name:n,text:s,time:r}),o=this.root.querySelector("div[commentid]");o?this.root.insertBefore(i,o):this.root.appendChild(i)}append({id:e,uid:t,avatar:a,name:n,text:s,time:r}){if(this._commentAlreadyThere(e))return;this._lastId=e;const i=CommentsTable._generateElement({id:e,uid:t,avatar:a,name:n,text:s,time:r});this.root.appendChild(i)}}const userStorage=Symbol();function setIntervalForAsync(e,t){function a(){e().then(n)}var n=setTimeout.bind(null,a,t);a()}function _getCommentId(e){if(e)return e.getAttribute("commentid")}class AllBoomsCommentsWidget extends HTMLElement{constructor(){super(),this.appID=decodeURIComponent(this.getAttribute("data-appid")),this.widgetID=decodeURIComponent(this.getAttribute("data-widgetid"));const e=function(){this[userStorage]=Object.assign([],{awaiters:{},clear:e})}.bind(this);e();const t=decodeURIComponent(this.getAttribute("data-lang")||"ru"),a=(argsDecode(this.getAttribute("data-strings")),Dictionary[t]),n=this.attachShadow({mode:"closed"});this.styles=new WidgetStyle(n);const s=createElement({name:"div",attrs:{class:"input-and-button-wrapper"},childs:[{name:"input",attrs:{placeholder:a.placeholder}},{name:"a",attrs:{href:"#",draggable:"false"},childs:[{name:"span"}]}]}),r=createElement({name:"div",attrs:{class:"comments-wrapper"}}),i=s.children[0],o=s.children[1],m=o.children[0];this.table=new CommentsTable(r),(async()=>{await new PerfectScrollbar(r,{root:n});var e=!0;r.addEventListener("ps-scroll-y",async()=>{e&&r.getBoundingClientRect().bottom-r.children[r.children.length-11].getBoundingClientRect().y>=0&&!this._requestBusy&&(this._requestBusy=!0,await this.requestComments()||(e=!1),this._requestBusy=!1)})})(),(async()=>{await locationProcess,await currentUser()?(i.setAttribute("placeholder",a.placeholder),m.innerText=a.submitText,o.addEventListener("click",()=>{i.value?(i.disabled=!0,o.classList.add("disabled"),API.comments.external.add({token:currentToken(),widget_id:this.widgetID,text:i.value}).then(({id:e,timestamp:t})=>{i.value="",i.disabled=!1,o.classList.remove("disabled")})):alert(a.noCommentText)})):(i.setAttribute("placeholder",a.userNotLogged),i.disabled=!0,o.classList.add("login-highlight"),m.innerText=a.login,o.addEventListener("click",e=>{const t=new Link(location.href);t.params.save_allbooms_token="",e.preventDefault(),location.href=`https://${APIReference.baseHost}/getToken?callback=${encodeURIComponent(t.href)}&appid=${encodeURIComponent(this.appID)}`})),n.append(s,r)})(),(async()=>{this._requestBusy=!0,await this.requestComments(),this._requestBusy=!1,setTimeout(this.listenForComments.bind(this),requestTimeout)})()}getFirstCommentId(){return _getCommentId(this.table.root.querySelector("div[commentid]"))}getLastCommentId(){const e=this.table.root.querySelectorAll("div[commentid]");return _getCommentId(e[e.length-1])}async requestComments(e=!1){const t=this.onNewComment.bind(this,e?"prepend":"append"),a={app_id:this.appID,widget_id:this.widgetID,after:e?this.getFirstCommentId():this.getLastCommentId(),reversed:e},n=await API.comments.external.list(a);return n.forEach(t),n.length}userInfo(e){const t=this[userStorage];return t.latest=e,t.awaiters[e]||(t.awaiters[e]=new Awaiter,t.push(e),wait(20).then(()=>{t.latest===e&&(t.clear(),API.user.getInfo({list:t}).then(e=>{t.forEach(a=>{t.awaiters[a].resolve(e[a])})}).catch(e=>{t.forEach(a=>{t.awaiters[a].reject(e)})}))})),t.awaiters[e]}async onNewComment(e,{id:t,userid:a,text:n,timestamp:s}){const{fullName:r,avatar:i}=await this.userInfo(a);this.table[e]({id:t,text:n,time:s,uid:a,name:r,avatar:i})}listenForComments(){setIntervalForAsync(this.requestComments.bind(this,!0),requestTimeout)}}const cssVars=(()=>{const e={"border-radius":2,width:280,height:400,"theme-color":"#00b1b3","highlighted-text-color":"#fff"};var t="";for(var a in e)t+=`--${a}:${"number"==typeof e[a]?e[a]+"px":e[a]};`;return t})();customElements.define("allbooms-comments",AllBoomsCommentsWidget);export default class{constructor(e,t,a){return a=a||{},createElement({name:"allbooms-comments",attrs:{"data-appid":encodeURIComponent(e),"data-widgetid":encodeURIComponent(t),"data-strings":argsEncode(a.strings),"data-lang":encodeURIComponent(a.lang||""),style:cssVars}})}};