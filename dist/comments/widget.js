import"../internal/roboto.js";import"../internal/allbooms-brand-icons.js";import APIReference from"../internal/APIref.js";import{createElement,htmlSafeText,normalizeDate,currentUser,Link,currentToken,argsEncode,argsDecode,Awaiter,wait}from"../internal/_system.js";import*as Dictionary from"./dictionary.js";import WidgetStyle from"./widget.style.js";import PerfectScrollbar from"../3rd-party/PerfectScrollbar/index.js";import textareaNOL from"../3rd-party/textareaNOL/index.js";const requestTimeout=2e3,API=new APIReference,locationProcess=(async()=>{const e=new Link(location.href);if(void 0!==e.params.save_allbooms_token&&e.params.token){await API.user.getMe({token:e.params.token})&&currentToken.save(e.params.token),delete e.params.save_allbooms_token,delete e.params.token,window.history.pushState(null,null,e.href)}})();class CommentsTable{constructor(e){this.root=e}static _dateUpdate(e,t){const a=normalizeDate(t);e.innerText!==a&&(e.innerText=a)}static _generateElement({id:e,uid:t,avatar:a,name:s,text:n,time:r}){const i=createElement({name:"div",attrs:{commentid:e},childs:[{name:"div",childs:[{name:"img",attrs:{src:a}}]},{name:"div",attrs:{class:"name"},childs:[{name:"a",attrs:{href:APIReference.host+"/"+t,target:"_blank"},html:htmlSafeText(s)}]},{name:"div",attrs:{class:"time"},html:normalizeDate(r)},{name:"div",attrs:{class:"comment"},html:htmlSafeText(n)}]});return setInterval(this._dateUpdate.bind(null,i.children[2],r),1e3),i}_commentAlreadyThere(e){return!!this.root.querySelector(`div[commentid="${e}"]`)}prepend({id:e,uid:t,avatar:a,name:s,text:n,time:r}){if(this._commentAlreadyThere(e))return;this._lastId=e;const i=CommentsTable._generateElement({id:e,uid:t,avatar:a,name:s,text:n,time:r}),o=this.root.querySelector("div[commentid]");o?this.root.insertBefore(i,o):this.root.appendChild(i)}append({id:e,uid:t,avatar:a,name:s,text:n,time:r}){if(this._commentAlreadyThere(e))return;this._lastId=e;const i=CommentsTable._generateElement({id:e,uid:t,avatar:a,name:s,text:n,time:r});this.root.appendChild(i)}}const userStorage=Symbol();function setIntervalForAsync(e,t){function a(){e().then(s)}var s=setTimeout.bind(null,a,t);a()}function _getCommentId(e){if(e)return e.getAttribute("commentid")}class AllBoomsCommentsWidget extends HTMLElement{constructor(){super(),this.appID=decodeURIComponent(this.getAttribute("data-appid")),this.widgetID=decodeURIComponent(this.getAttribute("data-widgetid"));const e=function(){this[userStorage]=Object.assign([],{awaiters:this[userStorage]?this[userStorage].awaiters:{},clear:e})}.bind(this);e();const t=decodeURIComponent(this.getAttribute("data-lang")||"ru"),a=(argsDecode(this.getAttribute("data-strings")),Dictionary[t]),s=this.attachShadow({mode:"closed"});this.styles=new WidgetStyle(s);const n=this.styles["*"].get("--input-height"),r=this.styles.textarea.get("line-height"),i=n.get(),o=createElement({name:"div",attrs:{class:"input-and-button-wrapper"},childs:[{name:"textarea",attrs:{placeholder:a.placeholder}},{name:"a",attrs:{href:"#",draggable:"false"},childs:[{name:"span"}]}]}),m=createElement({name:"div",attrs:{class:"comments-wrapper"}}),l=o.children[0],d=o.children[1],c=d.children[0];this.table=new CommentsTable(m),new PerfectScrollbar(m,{root:s});let h=!0;m.addEventListener("ps-scroll-y",async()=>{h&&m.getBoundingClientRect().bottom-m.children[m.children.length-11].getBoundingClientRect().y>=0&&!this._requestBusy&&(this._requestBusy=!0,await this.requestComments()||(h=!1),this._requestBusy=!1)});const u=(()=>{let e=4;return()=>{const t=r.get(),a=textareaNOL(l,t)||1;a>e?n.set(n.get()+t*(a-e)):a<e&&n.set(n.get()-t*(e-a)),e=a}})();setInterval(u,200),(async()=>{await locationProcess,await currentUser()?(l.setAttribute("placeholder",a.placeholder),c.innerText=a.submitText,d.addEventListener("click",()=>{l.value?(l.disabled=!0,d.classList.add("disabled"),API.comments.external.add({token:currentToken(),widget_id:this.widgetID,text:l.value}).then(({id:e,timestamp:t})=>{l.value="",l.disabled=!1,n.set(i),d.classList.remove("disabled")})):alert(a.noCommentText)})):(l.setAttribute("placeholder",a.userNotLogged),l.disabled=!0,d.classList.add("login-highlight"),c.innerText=a.login,d.addEventListener("click",e=>{const t=new Link(location.href);t.params.save_allbooms_token="",e.preventDefault(),location.href=`${APIReference.host}/getToken?callback=${encodeURIComponent(t.href)}&appid=${encodeURIComponent(this.appID)}`})),s.append(o,m)})(),(async()=>{this._requestBusy=!0,await this.requestComments(),this._requestBusy=!1,setTimeout(this.listenForComments.bind(this),requestTimeout)})()}getFirstCommentId(){return _getCommentId(this.table.root.querySelector("div[commentid]"))}getLastCommentId(){const e=this.table.root.querySelectorAll("div[commentid]");return _getCommentId(e[e.length-1])}async requestComments(e=!1){const t=this.onNewComment.bind(this,e?"prepend":"append"),a={app_id:this.appID,widget_id:this.widgetID,after:e?this.getFirstCommentId():this.getLastCommentId(),reversed:e},s=await API.comments.external.list(a);return s.forEach(t),s.length}async userInfo(e){const t=this[userStorage];return t.latest=e,t.awaiters[e]||(t.awaiters[e]=new Awaiter,t.push(e),wait(20).then(()=>{t.latest===e&&(t.clear(),API.user.getInfo({list:t}).then(e=>{t.forEach(a=>{t.awaiters[a].resolve(e[a])})}).catch(e=>{t.forEach(a=>{t.awaiters[a].reject(e)})}))})),await t.awaiters[e]}async onNewComment(e,{id:t,userid:a,text:s,timestamp:n}){const{fullName:r,avatar:i}=await this.userInfo(a);this.table[e]({id:t,text:s,time:n,uid:a,name:r,avatar:i})}listenForComments(){setIntervalForAsync(this.requestComments.bind(this,!0),requestTimeout)}}const cssVars=(()=>{const e={"border-radius":2,width:280,height:400,"theme-color":"#00b1b3","highlighted-text-color":"#fff"};var t="";for(var a in e)t+=`--${a}:${"number"==typeof e[a]?e[a]+"px":e[a]};`;return t})();customElements.define("allbooms-comments",AllBoomsCommentsWidget);export default class{constructor(e,t,a){return a=a||{},createElement({name:"allbooms-comments",attrs:{"data-appid":encodeURIComponent(e),"data-widgetid":encodeURIComponent(t),"data-strings":argsEncode(a.strings),"data-lang":encodeURIComponent(a.lang||""),style:cssVars}})}};